<include file="./Public/html/header.html" />
<style type="text/css">
<!--
body{font-size:12px;}.l-table-edit-td{padding:10px 20px;}.l-table-edit-td input{width:130px;}.l-button-submit,.l-button-test{width:80px;float:left;margin-left:10px;padding-bottom:2px;}.l-verify-tip{left:230px;top:120px;}.l-table-edit tr td span{color:#f30;padding-left:5px;}.tipmsg{color:#f30;}.tip_msg3{color:#fb072f;}#business_start_hour,#business_start_minute,#business_end_hour,#business_end_minute{width:100px}#image-preview{position:relative;}#image-preview-outter{display:block;}#image-preview-delete{display:block;position:absolute;top:0px;left:144px;background:url(/Public/images/delete.png) no-repeat;background-color:#fff;width:16px;height:16px;}#is_top,#is_free_parking{width:56px;}@-webkit-keyframes progress-bar-stripes{from{background-position:40px 0}to{background-position:0 0}}@keyframes progress-bar-stripes{from{background-position:40px 0}to{background-position:0 0}}.progress{height:20px;margin-bottom:20px;overflow:hidden;background-color:#f5f5f5;border-radius:4px;-webkit-box-shadow:inset 0 1px 2px rgba(0,0,0,0.1);box-shadow:inset 0 1px 2px rgba(0,0,0,0.1)}.progress-bar{float:left;width:0;height:100%;font-size:12px;line-height:20px;color:#fff;text-align:center;background-color:#428bca;-webkit-box-shadow:inset 0 -1px 0 rgba(0,0,0,0.15);box-shadow:inset 0 -1px 0 rgba(0,0,0,0.15);-webkit-transition:width .6s ease;transition:width .6s ease}.progress-striped .progress-bar{background-image:-webkit-linear-gradient(45deg,rgba(255,255,255,0.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,0.15) 50%,rgba(255,255,255,0.15) 75%,transparent 75%,transparent);background-image:linear-gradient(45deg,rgba(255,255,255,0.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,0.15) 50%,rgba(255,255,255,0.15) 75%,transparent 75%,transparent);background-size:40px 40px}.progress.active .progress-bar{-webkit-animation:progress-bar-stripes 2s linear infinite;animation:progress-bar-stripes 2s linear infinite}.progress-bar-success{background-color:#5cb85c}.progress-striped .progress-bar-success{background-image:-webkit-linear-gradient(45deg,rgba(255,255,255,0.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,0.15) 50%,rgba(255,255,255,0.15) 75%,transparent 75%,transparent);background-image:linear-gradient(45deg,rgba(255,255,255,0.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,0.15) 50%,rgba(255,255,255,0.15) 75%,transparent 75%,transparent)}.progress-bar-info{background-color:#5bc0de}.progress-striped .progress-bar-info{background-image:-webkit-linear-gradient(45deg,rgba(255,255,255,0.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,0.15) 50%,rgba(255,255,255,0.15) 75%,transparent 75%,transparent);background-image:linear-gradient(45deg,rgba(255,255,255,0.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,0.15) 50%,rgba(255,255,255,0.15) 75%,transparent 75%,transparent)}.progress-bar-warning{background-color:#f0ad4e}.progress-striped .progress-bar-warning{background-image:-webkit-linear-gradient(45deg,rgba(255,255,255,0.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,0.15) 50%,rgba(255,255,255,0.15) 75%,transparent 75%,transparent);background-image:linear-gradient(45deg,rgba(255,255,255,0.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,0.15) 50%,rgba(255,255,255,0.15) 75%,transparent 75%,transparent)}.progress-bar-danger{background-color:#d9534f}.progress-striped .progress-bar-danger{background-image:-webkit-linear-gradient(45deg,rgba(255,255,255,0.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,0.15) 50%,rgba(255,255,255,0.15) 75%,transparent 75%,transparent);background-image:linear-gradient(45deg,rgba(255,255,255,0.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,0.15) 50%,rgba(255,255,255,0.15) 75%,transparent 75%,transparent)}
-->
</style>
<table cellpadding="0" cellspacing="0" class="l-table-edit">
    <tr>
        <td align="right" class="l-table-edit-td"><span>*</span>标题：</td>
        <td align="left" class="l-table-edit-td"><input type="text" name="title" id="title" value="<{$news['title']}>" /></td>
        <td align="left" class="tipmsg"></td>
    </tr>
    <tr>
        <td align="right" class="l-table-edit-td"><span>*</span>资讯类别：</td>
        <td align="left" class="l-table-edit-td">
            <select id="type_id" name="type_id">
                <option value="0">--请选择资讯类别--</option>
                <?php foreach($news_type as $val):?>
                <option value="<{$val.id}>" <?php if($val['id'] == $news['type_id']) echo 'selected="selected"';?>><{$val.name}></option>
                <?php endforeach;?>
            </select>
        </td>
        <td align="left" class="tipmsg" id="type_tip"></td>
    </tr>
    <!--
    <tr>
        <td align="right" class="l-table-edit-td">营业开始时间：</td>
        <td align="left" class="l-table-edit-td">
            <select id="business_start_hour">
                <option value="-1" <if condition="$news['business_start_hour'] eq -1">selected</if>>--请选择--</option>
                <php>
                    for ($i = 0; $i <=23 ;$i++) {
                        if ($i < 10) {
                            $j = "0".$i;
                        } else {
                            $j = $i;
                        }
                        if ($news['business_start_hour'] == $i) {
                            echo "<option value=\"{$i}\" selected>{$j}</option>";
                        } else {
                               echo "<option value=\"{$i}\">{$j}</option>";
                        }
                    }
                </php>
            </select>&nbsp;&nbsp;时&nbsp;&nbsp;
            <select id="business_start_minute">
                <option value="-1" <if condition="$news['business_start_minute'] eq -1">selected</if>>--请选择--</option>
                <php>
                    for ($i = 0; $i <=59 ;$i++) {
                        if ($i < 10) {
                            $j = "0".$i;
                           } else {
                            $j = $i;
                        }
                        if ($news['business_start_minute'] == $i) {
                            echo "<option value=\"{$i}\" selected>{$j}</option>";
                        } else {
                               echo "<option value=\"{$i}\">{$j}</option>";
                        }                        
                    }
                </php>
            </select>&nbsp;&nbsp;分
        </td>
        <td align="left" class="tipmsg"></td>
    </tr>
    <tr>
        <td align="right" class="l-table-edit-td">营业结束时间：</td>
        <td align="left" class="l-table-edit-td">
            <select id="business_end_hour">
                <option value="-1" <if condition="$news['business_end_hour'] eq -1">selected</if>>--请选择--</option>
                <php>
                    for ($i = 0; $i <=23 ;$i++) {
                        if ($i < 10) {
                            $j = "0".$i;
                        } else {
                            $j = $i;
                        }
                        if ($news['business_end_hour'] == $i) {
                            echo "<option value=\"{$i}\" selected>{$j}</option>";
                        } else {
                               echo "<option value=\"{$i}\">{$j}</option>";
                        }
                    }
                </php>
            </select>&nbsp;&nbsp;时&nbsp;&nbsp;
            <select id="business_end_minute">
                <option value="-1" <if condition="$news['business_end_minute'] eq -1">selected</if>>--请选择--</option>
                <php>
                    for ($i = 0; $i <=59 ;$i++) {
                        if ($i < 10) {
                            $j = "0".$i;
                           } else {
                            $j = $i;
                        }
                        if ($news['business_end_minute'] == $i) {
                            echo "<option value=\"{$i}\" selected>{$j}</option>";
                        } else {
                               echo "<option value=\"{$i}\">{$j}</option>";
                        }
                    }
                </php>
            </select>&nbsp;&nbsp;分
        </td>
        <td align="left" class="tipmsg"></td>
    </tr>
    <tr>
        <td align="right" class="l-table-edit-td">免费停车：</td>
        <td align="left" class="l-table-edit-td">
            <select name="is_free_parking" id="is_free_parking">
                <option value="0" <if condition="$news['is_free_parking'] eq 0">selected</if>>否</option>
                <option value="1" <if condition="$news['is_free_parking'] eq 1">selected</if>>是</option>
            </select>
        </td>
        <td align="left" class="tipmsg"></td>
    </tr>
    -->
    <tr>
        <td align="right" class="l-table-edit-td">顶置：</td>
        <td align="left" class="l-table-edit-td">
            <select name="is_top" id="is_top">
                <option value="0" <if condition="$news['is_top'] eq 0">selected</if>>否</option>
                <option value="1" <if condition="$news['is_top'] eq 1">selected</if>>是</option>
            </select>
        </td>
        <td align="left" class="tipmsg"></td>
    </tr>
    <!--
    <tr>
        <td align="right" class="l-table-edit-td">人均消费：</td>
        <td align="left" class="l-table-edit-td"><input type="text" name="per_fee" id="per_fee" value="<{$news['per_fee']}>" />&nbsp;元</td>
        <td align="left" class="tipmsg"></td>
    </tr>
    <tr>
        <td align="right" class="l-table-edit-td">地址：</td>
        <td align="left" class="l-table-edit-td">
            <textarea name="address" id="address" style="resize:none;" onfocus="javascript:checkLength(this, 'address_tip');" onkeydown="javascript:checkLength(this, 'address_tip');" onkeyup="javascript:checkLength(this, 'address_tip');" maxLength="50"><{$news['address']}></textarea>
        </td>
        <td align="left" class="tipmsg" id="address_tip"></td>
    </tr>
    <tr>
        <td align="right" class="l-table-edit-td">乘车路线：</td>
        <td align="left" class="l-table-edit-td">
            <textarea name="bus_path" id="bus_path" style="resize:none;" onfocus="javascript:checkLength(this, 'bus_path_tip');" onkeydown="javascript:checkLength(this, 'bus_path_tip');" onkeyup="javascript:checkLength(this, 'bus_path_tip');" maxLength="50"><{$news['bus_path']}></textarea>
        </td>
        <td align="left" class="tipmsg" id="bus_path_tip"></td>
    </tr>
    <tr>
        <td align="right" class="l-table-edit-td">资讯简介：</td>
        <td align="left" class="l-table-edit-td">
            <textarea name="description" id="description" style="resize:none;" onfocus="javascript:checkLength(this, 'description_tip');" onkeydown="javascript:checkLength(this, 'description_tip');" onkeyup="javascript:checkLength(this, 'description_tip');" maxLength="80"><{$news['description']}></textarea>
        </td>
        <td align="left" class="tipmsg" id="description_tip"></td>
    </tr>
    -->
    <tr>
        <td align="right" class="l-table-edit-td">资讯简介：</td>
        <td align="left" class="l-table-edit-td">
            <textarea name="description" id="description" style="resize:none;width:240px;height:140px;"><{$news['description']}></textarea>
        </td>
        <td align="left" class="tipmsg"></td>
    </tr>
    <tr>
        <td align="right" class="l-table-edit-td"><span>*</span>资讯图片：</td>
        <td align="left" class="l-table-edit-td">
            <span class="btn btn-success fileinput-button" style="color:#fff;">
                &nbsp;&nbsp;选择图片
                <input id="fileupload" type="file" name="files[]" />
                <input id="image" type="hidden" value="<{$news['image']}>" />
            </span>
            <br />
            <br />
            <div id="progress" class="progress" style="display:none;">
                <div class="progress-bar progress-bar-success"></div>
            </div>
        </td>
        <td align="left" class="tipmsg" id="image_tip">
            <div id="image-preview">
                <a href="<{$news['src']}>" target="_blank" title='点击查看原图' id="image-preview-outter">
                    <img src="<{$news['src']}>" width="160" height="90" border="0" />
                </a>
                <a href="javascript:void(0);" onclick="delete_image('<{$news['image']}>');" id="image-preview-delete" title="删除">
                </a>
            </div>
        </td>
    </tr>
</table>
<script type="text/javascript">
//<![CDATA[
$(function() {
    $("#title").focus(function() {
        addTip($(this).parent('td').next('td:last'), '资讯标题不能超过20个字');
    }).blur(function() {
        removeTip($(this).parent('td').next('td:last'));
        ckTitle();
    });
    /* $("#business_start_hour, #business_start_minute").change(function() {
        removeTip($(this).parent('td').next('td:last'));
        ckStartTime();
    });
    $("#business_end_hour, #business_end_minute").change(function() {
        removeTip($(this).parent('td').next('td:last'));
        ckEndTime();
    });
    $("#per_fee").focus(function() {
        addTip($(this).parent('td').next('td:last'), '人均消费最多保留两位小数');
    }).blur(function() {
         removeTip($(this).parent('td').next('td:last'));
         ckPerFee();
    }); */
    $('#fileupload').fileupload({
        maxNumberOfFiles: 1,
        acceptFileTypes: /(\.|\/)(jpe?g|png)$/i,
        maxFileSize: 2097152,
        minFileSize: 1,
        url: '<{:U("News/upload")}>',
        dataType: 'json',
        send: function (e, data) {
            $("#progress").show();
        },
        done: function (e, data) {
            if (data.result.status) {
                $("#progress").hide();
                $("#image_tip").html("<div id='image-preview'>"+
                                        "<a href='"+data.result.src+"' target='_blank' title='点击查看原图' id='image-preview-outter'>"+
                                            "<img src='"+data.result.src+"' width='160' height='90' border='0' />"+
                                        "</a>"+
                                        "<a href='javascript:void(0);' onclick=\"delete_image(\'"+data.result.filename+"\');\" id='image-preview-delete' title='删除'>"+
                                        "</a>"+
                                    "</div>");
                $("#image").val(data.result.filename);
            } else {
                $("#image_tip").html(data.result.msg);
            }
        },
        progressall: function (e, data) {
            var progress = parseInt(data.loaded / data.total * 100, 10);
            $('#progress .progress-bar').css(
                'width',
                progress + '%'
            );
        }
    });
});

//添加提示
function addTip(my, tip) {
    removeTip(my);
    var tip1 = '<div class="tip_msg">';
    var tip2 = '</div>';
    my.append(tip1+tip+tip2);
}

//删除提示
function removeTip(my) {
    my.find(".tip_msg").remove();
}

//检测资讯标题
function ckTitle() {
    var title = $.trim($("#title").val());
    if (title.length <= 0) {
        addTip($("#title").parent('td').next('td:last'), '资讯标题不能为空');
        return false;
    } else if (title.length > 20) {
        addTip($("#title").parent('td').next('td:last'), '资讯标题不能超过20个字');
        return false;
    }
    return true;
}

//检测资讯简介
function ckDesc() {
    var description = $.trim($("#description").val());
    if (description.length == 0) {
        addTip($("#description").parent('td').next('td:last'), '资讯简介不能为空');
        return false;
    }
    return true;
}
/* 
//检测开始营业时间
function ckStartTime() {
    var start_hour = $("#business_start_hour").val();
    var start_minute = $("#business_start_minute").val();
    if (start_hour >= 0 && start_minute < 0) {
        addTip($("#business_start_hour").parent('td').next('td:last'), '请选择完整的开始营业时间');
        return false;
    } else if (start_hour < 0 && start_minute >= 0) {
        addTip($("#business_start_hour").parent('td').next('td:last'), '请选择完整的开始营业时间');
        return false;
    }
    return true;
}

//检测结束营业时间
function ckEndTime() {
    var end_hour = $("#business_end_hour").val();
    var end_minute = $("#business_end_minute").val();
    if (end_hour >= 0 && end_minute < 0) {
        addTip($("#business_end_hour").parent('td').next('td:last'), '请选择完整的结束营业时间');
        return false;
    } else if (end_hour < 0 && end_minute >= 0) {
        addTip($("#business_end_hour").parent('td').next('td:last'), '请选择完整的结束营业时间');
        return false;
    }
    return true;
}

//检测人均消费
function ckPerFee() {
    var per_fee = $.trim($("#per_fee").val());
    if (per_fee.length > 0) {
        var priceReg = /^\d+(\.\d{1,2})?$/;
        if (!priceReg.test(per_fee)) {
            addTip($("#per_fee").parent('td').next('td:last'), '人均消费最多只能保留两位小数，<br />不能包含非数字和\'.\'以外的字符，<br />不能以\'.\'结尾');
            return false;
        }
        if (parseFloat(per_fee) > 99999999.99) {
            addTip($("#per_fee").parent('td').next('td:last'), '人均消费已经超过范围');
            return false;
        }
        return true;
    }
    return true;
}

//检测长度
function checkLength(obj, tips) {
    var maxLength = obj.maxLength;
    var desc = obj.value;
    if (desc.length <= maxLength) {
        document.getElementById(tips).innerHTML = '还剩下'+(maxLength-desc.length)+'个字';
    }
    obj.onblur = function() {
        document.getElementById(tips).innerHTML = '';
    }
}
 */
//检测图片
function ckImage() {
    var image = $.trim($("#image").val());
    if (image.length <= 0) {
        addTip($("#image_tip"), '资讯图片不能为空');
        return false;
    }
    return true;
}

//检测分类
function ckType(){
    var type_id = $('#type_id').val();
    if(Number(type_id) <= 0){
        addTip($('#type_tip'),'请选择资讯类别');
        return false;
    }
    return true;
}

//检测表单 
function checkForm() {
    if (!ckTitle()) return false;
    if (!ckType()) return false;
    if (!ckDesc()) return false;
    /* if (!ckStartTime()) return false;
    if (!ckEndTime()) return false; */
    if (!ckImage()) return false;
    var title = $.trim($("#title").val());
    var type_id = $('#type_id').val();
    /* var start_hour = $("#business_start_hour").val();
    var start_minute = $("#business_start_minute").val();
    var end_hour = $("#business_end_hour").val();
    var end_minute = $("#business_end_minute").val();
    var is_free_parking = $("#is_free_parking").val(); */
    var is_top = $("#is_top").val();
    /* var per_fee = $.trim($("#per_fee").val());
    var address = $.trim($("#address").val());
    var bus_path = $.trim($("#bus_path").val()); */
    var description = $.trim($("#description").val());
    var image = $.trim($("#image").val());
    /* var business_start_time = generateTime(start_hour, start_minute);
    var business_end_time = generateTime(end_hour, end_minute); */
    /* return {title: title, 
            type_id:type_id,
            business_start_time: business_start_time, 
            business_end_time: business_end_time, 
            is_free_parking: is_free_parking,
            is_top: is_top,
            per_fee: per_fee,
            address: address,
            bus_path: bus_path,
            description: description,
            image: image} */
    return {
        title: title,
        type_id: type_id,
        is_top: is_top,
        description: description,
        image: image
        };
}
/* 
//生成营业时间
function generateTime(hour, minute) {
    if (hour == '-1' || minute == '-1') {
        return "";
    } else {
        if (parseInt(hour) < 10) {
            hour = '0' + hour;
        }
        if (parseInt(minute) < 10) {
            minute = '0' + minute;
        }
        return hour + ":" +minute;
    }
}
 */
//提交表单
function updateNewsFormSubmit() {
    if (checkForm()) {
        $.post('<{:U("News/update")}>?id=<{$news["id"]}>', checkForm(), function(data) {
            window.parent.updateNewsCallback(data);
        }, 'json');
    }
}

//删除图片
function delete_image(filename) {
    $.post('<{:U("News/delete_image")}>', {filename: filename}, function(data) {
        if (data.status) {
            $("#image_tip").empty();
            $("#image").val("");
        } else {
            $.ligerDialog.alert(data.msg, '出错了(>_<)', 'error');
            return false;
        }
    }, 'json');
}
//]]>
</script>
<include file="./Public/html/footer.html" />